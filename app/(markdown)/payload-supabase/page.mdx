import { ThemeToggle } from "@/components/theme/theme-toggle";
import { Meta } from "@/components/mdx/meta";
import { PostWrapper } from "@/components/mdx/post-wrapper";

export const metadata = {
  title: "Use Cloudflare R2 with Payload CMS",
  description:
    "A guide to integrating Cloudflare R2 with Payload CMS for efficient media storage",
};

<Meta {...metadata} className="mb-8" />

<PostWrapper>

# Using Supabase with Payload CMS 3

Hello fellow developer! This guide walks you through how to integrate [Supabase](https://supabase.com/) with [Payload CMS 3](https://payloadcms.com/docs/). The goal is to keep it simple, direct, and show you the core ideas so you can extend them to your unique use-case.

---

## Why Supabase + Payload CMS?

- **Supabase** provides a Postgres database, authentication, storage, and more.  
- **Payload CMS** is a TypeScript-based headless CMS that’s extensible, self-hosted, and easy to integrate with your existing stack.

By using them together, you can:
1. **Leverage Supabase Authentication** in Payload to manage your users and roles.
2. **Use Supabase’s powerful database** for storing or reading data.
3. **Take advantage of Supabase Storage** for files or media while Payload handles structured content.

---

## Prerequisites

1. **Node.js** (v16+)
2. **Payload CMS v3** (installed locally)
3. **Supabase Project** (set up in your [Supabase dashboard](https://app.supabase.com/))

---

## 1. Set Up Your Supabase Project

If you don’t have a Supabase project yet:

1. Go to [app.supabase.com](https://app.supabase.com/) and create a new project.
2. Save your Supabase project credentials:
   - **Project URL** (often called `supabaseUrl`)
   - **API Key** (often called `supabaseKey` or `anonKey`)

You’ll need these values to configure the Supabase client in Payload.

---

## 2. Initialize Your Payload CMS 3 Project

If you haven’t already installed Payload, you can do so by running:

```bash
npx create-payload-app my-payload-app
```

Follow the prompts to choose your configuration. Once it’s set up:

```bash
cd my-payload-app
npm install
npm run dev
```

By default, your local Payload CMS runs at `http://localhost:3000/admin`.

---

## 3. Install the Supabase Client

Within your Payload project, install Supabase’s JavaScript client:

```bash
npm install @supabase/supabase-js
```

---

## 4. Connect Supabase and Payload

Create a helper module (e.g. `supabaseClient.ts` or `supabaseClient.js`) to configure and export a Supabase client you can reuse throughout your code:

```ts
// supabaseClient.ts
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.SUPABASE_URL || '';
const supabaseKey = process.env.SUPABASE_ANON_KEY || '';

export const supabase = createClient(supabaseUrl, supabaseKey);
```

Add the corresponding `.env` variables:

```bash
# .env
SUPABASE_URL=https://xyzcompany.supabase.co
SUPABASE_ANON_KEY=your-anon-key
```

> **Note**: For production, you might want to use the service role key or a more secure environment variable. Keep your credentials safe!

---

## 5. Example: Using Supabase in Payload Hooks

A common scenario might be using Supabase whenever a new document is created or updated in Payload. For instance, you could create a user in Supabase when a new `User` document is created in Payload.

```ts
// payload.config.ts
import { buildConfig } from 'payload/config';
import { supabase } from './supabaseClient';

export default buildConfig({
  // ...rest of your Payload config
  collections: [
    {
      slug: 'users',
      fields: [
        {
          name: 'email',
          type: 'email',
          required: true
        },
        {
          name: 'password',
          type: 'text',
          required: true
        }
      ],
      hooks: {
        afterChange: [
          async ({ operation, doc }) => {
            if (operation === 'create') {
              // Create a user in Supabase
              const { email, password } = doc;
              const { error } = await supabase.auth.signUp({
                email,
                password,
              });

              if (error) {
                console.error('Error creating user in Supabase:', error.message);
              }
            }
          }
        ]
      }
    },
  ],
});
```

- **`afterChange`** is a Payload hook that triggers when a document is created or updated.
- **`operation === 'create'`** ensures we only create the user in Supabase when the document is newly added.

---

## 6. Example: Using Supabase Storage in a Payload Collection

Suppose you want to leverage Supabase Storage to host images or files. You could store an image in Payload but also upload it to Supabase Storage in an `afterChange` hook:

```ts
// payload.config.ts
import { supabase } from './supabaseClient';

export default buildConfig({
  collections: [
    {
      slug: 'media',
      fields: [
        {
          name: 'file',
          type: 'upload',
          relationTo: 'media-files',
        },
      ],
      hooks: {
        afterChange: [
          async ({ doc }) => {
            const fileData = doc?.file;
            if (fileData) {
              // This could be the file buffer, filename, etc.
              const fileBuffer = fileData?.buffer;
              const fileName = fileData?.filename || 'payload-upload';

              // Upload to Supabase Storage
              const { error } = await supabase.storage
                .from('your-bucket-name')
                .upload(`images/${fileName}`, fileBuffer);

              if (error) {
                console.error('Error uploading file to Supabase:', error.message);
              } else {
                console.log('File uploaded successfully to Supabase!');
              }
            }
          },
        ],
      },
    },
  ],
});
```

Adapt this to your actual file handling strategy. Payload’s `upload` fields can be configured to store locally or elsewhere before you sync it to Supabase.

---

## 7. Authentication Considerations

1. **Using Supabase Auth for the Payload Admin**: Payload has its own auth, but you could offload user management to Supabase. In that case, you’d integrate or override Payload’s auth logic with Supabase.
2. **JWT vs. Session**: Payload uses JWT-based authentication. Supabase also uses JWT under the hood with additional helpers. Make sure you handle tokens securely if you’re bridging the two systems.

---

## 8. Deployment Tips

- **Self-Hosting**: Both Supabase and Payload can be self-hosted. Ensure your environment variables (Supabase URL, keys, etc.) are correctly set in Docker, AWS, or wherever you host.
- **Netlify / Vercel**: If you host your front-end on Netlify or Vercel, keep your Payload server and Supabase project accessible from that environment.
- **Security**: Use secure tokens (like the service role key) only on the server side. Never expose them in public code.

---

## Next Steps

- **Explore Payload Plugins**: You could build a dedicated Payload plugin to encapsulate your Supabase integration.
- **Fine-Tune Hooks**: Payload’s hooks are very flexible—use them to integrate Supabase logic exactly where you need it.
- **Consider Real-Time**: Supabase provides real-time capabilities. You could push real-time updates from Supabase into your Payload front-end or use webhooks that update Payload content.

---

## Conclusion

That’s it! By combining Supabase and Payload CMS 3, you have a flexible, powerful system for data storage, user management, and file uploads. The best part is that both are straightforward once you get the hang of them.

Feel free to adapt the examples above to fit your exact use-case. Let me know if you have any questions—I’m happy to help. Keep building awesome stuff!

**Happy coding!**

</PostWrapper>